<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
    <meta charset="UTF-8">
    <title>Title</title>
</head>

    <style>
        .reply-box{
            /*border: 1px solid black;*/
            /*margin-bottom: 20px;*/
            padding: 18px 25px 24px;
            border-bottom: 1px solid #ccc;
        }

        .box{
            border: 1px solid black;
        }

        .replyModifyingForm{
            display: none;
        }

        .read-title{
            font-size: 26px;
            color: #000;
        }

        .read-title{
            margin-top: 10px;
        }

        .writer-info{
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .writer-nameNDate{
            display: flex;
            flex-direction: row;
        }
        .readBoard-btn-box{
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-bottom: 34px;
        }

        .read-reply-box{
            background: #fafafa;
            display: flex;
            height: 207px;
            justify-content: center;
            align-items: center;
            margin-bottom: 28px;
        }

        .read-reply-form{
            width: 100%;
            padding: 10px 60px 10px 60px;
        }

        .reply-textarea{
            width: 100%;
            /*height: 120px;*/
            box-sizing: border-box;
            padding: 20px;
            background: #fff;
            border: 1px solid #dfdfdf;
            font-size: 14px;
        }

        .read-reply-btn{
            display: flex;
            position: static;
            margin-top: 10px;
            justify-content: flex-end;
        }

        .reply-writer-info{
            display: flex;
            flex-direction: row;
            margin-bottom: 10px;
        }

        .reply-writer{
            margin-right: 18px;
        }
        .reply-regDate{
            color: #aaa;
        }

        .reply-text{
            font-size: 14px;
            color: #3d3d3d;
            font-weight: normal;
            line-height: 1.714;
        }

        .container replyContainer{

        }
    </style>
<body>

<th:block th:replace="~{/layout/basic :: setContent(~{this :: content})}">
  <th:block th:fragment="content">

      <div class="container">
          <div class="read-title">
              <strong th:text="${dto.title}" class="read-title"></strong>
          </div>

          <div class="writer-info">
              <div class="writer-nameNDate">
                  <a th:href="@{/member/myPage(email=${#authentication.principal.username})}" style="margin-right: 13px">
                      <span>[[${dto.memberName}]]</span>
                  </a>
                  <div th:if="${dto.regDate == dto.modDate}">
                      [[${#temporals.format(dto.regDate, 'yyyy/MM/dd')}]]
                  </div>
                  <div th:unless="${dto.regDate == dto.modDate}">
                      [[${#temporals.format(dto.modDate, 'yyyy/MM/dd')}]]
                  </div>
              </div>
              <div class="replyCounting">
                  <label>댓글 수</label>[[${dto.replyCount}]]
              </div>
          </div>

          <div class="ckEditor-content">
              <div th:utext="${dto.content}"></div>
          </div>
          <form id="remove-form" th:action="@{/board/remove}" method="post">
              <input type="hidden" name="bno" th:value="${dto.bno}">
              <input type="hidden" name="email" th:value="${dto.email}">
          </form>

          <div class="readBoard-btn-box">
              <a th:if="${pageRequestDTO.category != ''}" th:href="@{/board/list(page=${pageRequestDTO.page} , type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword}, category=${pageRequestDTO?.category} )}">
              <button class="btn btn-outline-info">리스트</button>
              </a>
              <a th:if="${pageRequestDTO.category == ''}" th:href="@{/board/list(page=${pageRequestDTO.page} , type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword} )}">
                  <button class="btn btn-outline-info">리스트</button>
              </a>
              <th:block th:with="user=${#authentication.principal}">
                  <div th:if="${user.username != null && user.username == dto.email}">
                      <a th:href="@{/board/modify(bno=${dto.bno}, page=${pageRequestDTO.page}, type=${pageRequestDTO.type}, keyword=${pageRequestDTO.keyword}, category=${pageRequestDTO.category} )}">
                          <button class="btn btn-outline-light modifyBtn">수정</button>
                      </a>
                      <button class="btn btn-outline-info removeBtn">삭제</button>
                  </div>
              </th:block>
          </div>

          <div th:with="user=${#authentication.principal}" class="read-reply-box">
              <div th:action="@{/replies/}" class="read-reply-form">
                  <input type="hidden" name="bno" th:value="${dto.bno}">
                  <textarea name="text" class="form-control reply-textarea" placeholder="댓글을 입력하세요." id="reply-input" style="height: 101px"></textarea>
                  <input type="hidden" name="email" class="form-control" placeholder="EMAIL" th:value="${#authentication.principal.username}" readonly>
                  <div class="read-reply-btn">
                    <button type="submit" class="btn btn-outline-info insertReplyBtn" >등록</button>
                  </div>
              </div>
          </div> <!--read-reply-box-->

<!--          <div>-->
<!--              <dvi>댓글을 작성하려면 <a th:href="@{/login}">로그인</a>이 필요합니다.</dvi>-->
<!--          </div>-->

          <div class="container replyContainer">

          </div>
      </div>




      <script th:inline="javascript">

          const auth = [[${#authentication.principal}]]

          const errors = [[${errors}]]
          console.info(errors)

          $(document).ready(function (){

              var bno = [[${dto.bno}]];

              var currentUser = [[${#authentication.principal.username}]]
              console.info("currentUser: " + currentUser);

              var userEmail = [[${dto.email}]];
              console.log("userEmail: " + userEmail);

              function formatTime(str){

                  var data = new Date(str);

                  return data.getFullYear() + "/" +
                      (data.getMonth() +1) + "/" +
                      data.getDate() + ":" +
                      data.getHours() + ":" +
                      data.getMinutes();

              }  // formatTime


              $(".removeBtn").on("click", function (){

                  if (!confirm("삭제 하시겠습니까?")){
                      console.info("confirmed");
                      return;
                  } // if

                  $("#remove-form").submit();

              }); // removeBtn

              loadReplyList();

              $(".insertReplyBtn").on("click", function (e){

                  e.preventDefault();

                  var replyText = $("#reply-input").val();
                  var replyWriter = $("input[name='email']").val();

                  var reply = {
                      bno: bno,
                      text: replyText,
                      email: replyWriter
                  }

                  console.info(reply);

                  $.ajax({
                      url:'/replies/',
                      method: 'POST',
                      data: JSON.stringify(reply),
                      contentType: 'application/json; charset=utf-8',
                      dataType: 'json',
                      success: function (result){

                          if (result == "success"){
                              console.info(result+ "번 댓글 작성 성공");

                          }
                          loadReplyList();
                          self.location.reload();
                          $("input[name='text']").val("");
                          $("input[name='email']").val("");
                      }

                  }); // ajax

              }); // insertReplyBtn event

              var repliesContainer = $(".replyContainer");

              function loadReplyList(){

                  $.getJSON('/replies/board/' + bno, function (arr){


                      var str = "";

                      $.each(arr, function (idx, dto){

                          str += ' <div class="reply-box" data-rno="'+dto.rno+'">';

                          str += '<div class="reply-writer-info">';
                          str += ' <span class="reply-writer">'+dto.memberName+'</span>';
                          str += ' <span class="reply-regDate">'+formatTime(dto.regDate)+'</span>';
                          str += '</div>';

                          str += ' <div class="reply-text"><span>'+dto.text+'</span></div>';

                          str += '<div class="reply-modify-div">';
                          str += '<button type="button" class="reply-modify-btn" data-email="'+dto.email+'">수정</button>';
                          str += '<button type="button" class="replyDeleteBtn" data-rno="'+dto.rno+'" data-email="'+dto.email+'">삭제</button>';
                          str += '</div>';

                          str += '<div class="replyModifyingForm">';
                          str += '<input type="text" name="text" value="'+dto.text+'" class="replyModifyTextInput">';
                          str += '<div>';
                          str += '<button type="button" class="doReplyModifying" data-rno="'+dto.rno+'" data-email="'+dto.email+'">수정</button>';
                          str += '<button type="button" class="cancelReplyModifying">취소</button></div></div>'
                          str += ' </div>';


                      }); // each

                      repliesContainer.html(str);

                  }); // getJSON /replies/board

              } // loadReplyList

              $(".replyContainer").on("click", ".replyDeleteBtn", function (){

                 var rno = $(this).data("rno");
                 console.info("rno: " + rno);

                 var writerEmail = $(this).data("email");
                 console.info(writerEmail)

                  if(currentUser != userEmail){
                      alert("댓글 작성자만 삭제가 가능합니다.");
                      return;
                  }

                 $.ajax({
                     url: '/replies/' + rno,
                     method: 'DELETE',
                     success: function (result){
                         if (result === "success"){
                             console.info(rno + "번 댓글이 삭제되었습니다.");
                             loadReplyList();
                         }
                     }
                 }); // ajax

              }); // reply delete event


              $(".replyContainer").on("click", ".reply-modify-btn", function (){

                  var writerEmail = $(this).data("email");
                  console.info("writerEmail: " + writerEmail);

                  // if(principalEmail == writerEmail){
                  if(currentUser != userEmail){
                      alert("댓글 작성자만 삭제가 가능합니다.");
                      return;
                  }

                  console.info("equals");

                  $(this).closest('.reply-box').find('.replyModifyingForm').css("display", "block");
                  $(this).closest('.reply-box').find('.reply-modify-div').css("display", "none");

                  $(".doReplyModifying").on('click', function (){

                      var rno = $(this).data("rno");
                      // var email = $(this).data("email");
                      var replyModifyInput = $(this).closest('.reply-box').find('.replyModifyTextInput').val();
                      console.info("replyModifyInput: " + replyModifyInput);

                      console.info("rno: " + rno);
                      // console.info("email: " + email);

                      var reply = {
                          rno: rno,
                          bno: bno,
                          text: replyModifyInput,
                          email: currentUser
                      }

                      console.info(reply);

                      $.ajax({
                          url: '/replies/' + rno,
                          method: 'PUT',
                          data: JSON.stringify(reply),
                          contentType: 'application/json; charset=utf-8',
                          success: function (result){
                              if(result === "success"){
                                  console.info(rno + "번 댓글 수정완료");
                              }
                              loadReplyList();
                          }
                      }) // ajax

                  }) // doReplyModifying event


              }); // reply modifying event




              $(".replyContainer").on("click", ".cancelReplyModifying", function (){

                  $(".replyModifyingForm").css("display", "none");
                  $(".reply-modify-div").css("display", "block");


              });  // reply canceling modify event


          }); // the end

      </script>

  </th:block>
</th:block>

</body>
</html>